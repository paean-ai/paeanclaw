<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PaeanClaw</title>
<link rel="manifest" href="/manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f172a;--surface:#1e293b;--surface2:#334155;--text:#e2e8f0;--text2:#94a3b8;--accent:#38bdf8;--accent2:#0ea5e9;--border:#334155;--radius:12px;--msg-user:#0ea5e9;--msg-ai:#1e293b}
@media(prefers-color-scheme:light){:root{--bg:#f8fafc;--surface:#fff;--surface2:#f1f5f9;--text:#1e293b;--text2:#64748b;--accent:#0284c7;--accent2:#0369a1;--border:#e2e8f0;--msg-user:#0284c7;--msg-ai:#f1f5f9}}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text)}
#app{display:flex;height:100dvh;overflow:hidden}
#sidebar{width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
#sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
#sidebar-header h1{font-size:16px;font-weight:700;color:var(--accent)}
#new-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:13px;font-weight:600}
#new-btn:hover{background:var(--accent2)}
#conv-list{flex:1;overflow-y:auto;padding:8px}
.conv-item{padding:10px 14px;border-radius:var(--radius);cursor:pointer;margin-bottom:4px;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text2);transition:background .15s}
.conv-item:hover,.conv-item.active{background:var(--surface2);color:var(--text)}
#main{flex:1;display:flex;flex-direction:column;min-width:0}
#chat-header{padding:14px 20px;border-bottom:1px solid var(--border);font-size:14px;font-weight:600;background:var(--surface)}
#messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
.msg{max-width:80%;padding:12px 16px;border-radius:var(--radius);line-height:1.6;font-size:14px;word-wrap:break-word;white-space:pre-wrap}
.msg.user{align-self:flex-end;background:var(--msg-user);color:#fff;border-bottom-right-radius:4px}
.msg.assistant{align-self:flex-start;background:var(--msg-ai);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.assistant code{background:var(--surface2);padding:1px 5px;border-radius:4px;font-size:13px}
.msg.assistant pre{background:var(--bg);padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0;font-size:13px}
.msg.assistant pre code{background:none;padding:0}
.msg.tool{align-self:flex-start;font-size:12px;color:var(--text2);background:var(--surface2);padding:8px 12px;border-radius:8px;font-family:monospace;max-width:90%;opacity:.7}
.typing{align-self:flex-start;color:var(--text2);font-size:13px;padding:8px 0}
.typing::after{content:'...';animation:dots 1.2s steps(3,end) infinite}
@keyframes dots{0%{content:'.'}33%{content:'..'}66%{content:'...'}}
#input-area{padding:16px 20px;border-top:1px solid var(--border);background:var(--surface);display:flex;gap:10px;align-items:flex-end}
#input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;color:var(--text);font-size:14px;resize:none;min-height:44px;max-height:160px;line-height:1.5;font-family:inherit;outline:none}
#input:focus{border-color:var(--accent)}
#send-btn{background:var(--accent);color:#fff;border:none;border-radius:10px;width:44px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s}
#send-btn:hover{background:var(--accent2)}
#send-btn:disabled{opacity:.4;cursor:default}
#send-btn svg{width:20px;height:20px}
.welcome{text-align:center;color:var(--text2);margin:auto;padding:40px}
.welcome h2{font-size:24px;margin-bottom:8px;color:var(--text)}
.welcome p{font-size:14px;line-height:1.6}
#menu-btn{display:none;background:none;border:none;color:var(--text);cursor:pointer;font-size:20px}
@media(max-width:768px){
  #sidebar{position:fixed;left:-280px;top:0;bottom:0;z-index:100;transition:left .25s}
  #sidebar.open{left:0}
  #menu-btn{display:block}
  .msg{max-width:90%}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99;display:none}
  .overlay.show{display:block}
}
</style>
</head>
<body>
<div id="app">
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
  <aside id="sidebar">
    <div id="sidebar-header">
      <h1>PaeanClaw</h1>
      <button id="new-btn" onclick="newConversation()">+ New</button>
    </div>
    <div id="conv-list"></div>
  </aside>
  <main id="main">
    <div id="chat-header">
      <button id="menu-btn" onclick="toggleSidebar()">&#9776;</button>
      <span id="header-title">PaeanClaw</span>
    </div>
    <div id="messages">
      <div class="welcome"><h2>PaeanClaw</h2><p>Your local AI agent, accessible anywhere.<br>Type a message to begin.</p></div>
    </div>
    <div id="input-area">
      <textarea id="input" rows="1" placeholder="Type a message..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button id="send-btn" onclick="send()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
    </div>
  </main>
</div>
<script>
const API = location.origin;
let convId = null;
let conversations = [];
let streaming = false;

async function loadConversations() {
  const res = await fetch(`${API}/api/conversations`);
  conversations = await res.json();
  renderConvList();
}

function renderConvList() {
  const el = document.getElementById('conv-list');
  el.innerHTML = conversations.map(c =>
    `<div class="conv-item${c.id===convId?' active':''}" onclick="selectConv('${c.id}')">${esc(c.title)}</div>`
  ).join('');
}

async function selectConv(id) {
  convId = id;
  renderConvList();
  closeSidebar();
  const res = await fetch(`${API}/api/messages?conversationId=${id}`);
  const msgs = await res.json();
  const el = document.getElementById('messages');
  el.innerHTML = '';
  for (const m of msgs) {
    if (m.role === 'user' || m.role === 'assistant') {
      appendMsg(m.role, m.content);
    }
  }
  el.scrollTop = el.scrollHeight;
  document.getElementById('header-title').textContent = conversations.find(c=>c.id===id)?.title || 'Chat';
}

function newConversation() {
  convId = null;
  document.getElementById('messages').innerHTML =
    '<div class="welcome"><h2>PaeanClaw</h2><p>Your local AI agent, accessible anywhere.<br>Type a message to begin.</p></div>';
  document.getElementById('header-title').textContent = 'PaeanClaw';
  renderConvList();
  closeSidebar();
}

function appendMsg(role, content) {
  const el = document.getElementById('messages');
  const welcome = el.querySelector('.welcome');
  if (welcome) welcome.remove();
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  if (role === 'assistant') {
    div.innerHTML = renderMarkdown(content);
  } else {
    div.textContent = content;
  }
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
  return div;
}

async function send() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if (!text || streaming) return;
  input.value = '';
  autoResize(input);
  appendMsg('user', text);
  streaming = true;
  document.getElementById('send-btn').disabled = true;

  const msgEl = document.getElementById('messages');
  const typingEl = document.createElement('div');
  typingEl.className = 'typing';
  typingEl.textContent = 'Thinking';
  msgEl.appendChild(typingEl);
  msgEl.scrollTop = msgEl.scrollHeight;

  let assistantDiv = null;
  let fullText = '';

  try {
    const res = await fetch(`${API}/api/chat`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ message: text, conversationId: convId }),
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'start') {
            convId = ev.conversationId;
          } else if (ev.type === 'content') {
            if (typingEl.parentNode) typingEl.remove();
            if (!assistantDiv) assistantDiv = appendMsg('assistant', '');
            fullText += ev.text;
            assistantDiv.innerHTML = renderMarkdown(fullText);
            msgEl.scrollTop = msgEl.scrollHeight;
          } else if (ev.type === 'tool_call') {
            if (typingEl.parentNode) typingEl.remove();
            const toolDiv = document.createElement('div');
            toolDiv.className = 'msg tool';
            toolDiv.textContent = `ðŸ”§ ${ev.name}`;
            msgEl.appendChild(toolDiv);
            msgEl.scrollTop = msgEl.scrollHeight;
          } else if (ev.type === 'done') {
            if (!assistantDiv && ev.content) {
              if (typingEl.parentNode) typingEl.remove();
              assistantDiv = appendMsg('assistant', ev.content);
            }
          } else if (ev.type === 'error') {
            if (typingEl.parentNode) typingEl.remove();
            appendMsg('assistant', `Error: ${ev.error}`);
          }
        } catch {}
      }
    }
  } catch (e) {
    if (typingEl.parentNode) typingEl.remove();
    appendMsg('assistant', `Connection error: ${e.message}`);
  }

  streaming = false;
  document.getElementById('send-btn').disabled = false;
  loadConversations();
}

function renderMarkdown(text) {
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--accent)">$1</a>')
    .replace(/^### (.+)$/gm, '<h3 style="margin:8px 0 4px;font-size:15px">$1</h3>')
    .replace(/^## (.+)$/gm, '<h2 style="margin:10px 0 6px;font-size:16px">$1</h2>')
    .replace(/^# (.+)$/gm, '<h1 style="margin:12px 0 8px;font-size:18px">$1</h1>')
    .replace(/^[-*] (.+)$/gm, '&bull; $1<br>')
    .replace(/^\d+\. (.+)$/gm, (m, p1, offset, str) => `${str.substring(0,offset).split('\n').length}. ${p1}<br>`)
    .replace(/\n/g, '<br>');
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
loadConversations();
document.getElementById('input').focus();
</script>
</body>
</html>
